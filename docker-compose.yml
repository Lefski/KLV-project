version: '3.9'


services:

  # App backend service
  app-server:
    container_name: klv-project_app-server
    build:
      context: springboot-backend
      dockerfile: Dockerfile
    ports:
      - '${SPRING_LOCAL_PORT}:${SPRING_DOCKER_PORT}'
    restart: no
    depends_on:
      app-db:
        condition: service_healthy
    environment:
      DB_SCHEMA: $DB_SCHEMA
      DB_USER: $DB_USER
      DB_PASSWORD: $DB_PASSWORD
      DB_SERVER: klv-project_app-db
      DB_PORT: $DB_DOCKER_PORT
    networks:
      - backend
      - frontend

  # App frontend service
  app-client:
    container_name: klv-project_app-client
    build:
      context: react-ui
      dockerfile: Dockerfile
      args:
        API_BASE_URL: 'http://localhost:${SPRING_DOCKER_PORT}/api'
    ports:
      - '${REACT_LOCAL_PORT}:${REACT_DOCKER_PORT}'
    restart: no
    depends_on:
      - app-server
    networks:
      - frontend

  # Database service (Mysql)
  app-db:
    container_name: klv-project_app-db
    image: mysql:latest
    ports:
      - '${DB_LOCAL_PORT}:${DB_DOCKER_PORT}'
    restart: no
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-u", "root", "-proot" ]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      MYSQL_ROOT_PASSWORD: $DB_ROOT_PASSWORD
    volumes:
      - db-data:/var/lib/mysql
      - ./db_model/klv_database.sql:/docker-entrypoint-initdb.d/klv_database.sql
    networks:
      - backend


volumes:
  db-data:


networks:
  backend:
  frontend: